# Fixing Backend: Simplify Player Naming

**Branch:** `fixing-backend`  
**Author:** Obinna  
**Date:** December 08, 2025

## Overview
This branch simplifies player name handling by leveraging the existing `player_name` field in the `GameResult` model instead of creating unnecessary payload duplication or custom fields. The change consolidates player identification into a single, consistent flow: capture name at quiz completion → include in primary game result POST → no extra API calls needed.

## Problem Solved
**Previous Approach (from `leaderboard-model-backend`):**
- Two separate POST requests:
  1. First payload to `/api/games/` with game result data (no player_name)
  2. Second payload to `/api/games/leaderboard/{difficulty}/` with only player_name
- This created data duplication, unnecessary network calls, and inconsistent player tracking

**This Branch:**
- Single POST request to `/api/games/` includes all game data plus `player_name`
- No second payload or extra leaderboard endpoint call
- Player name stored directly on GameResult model where it belongs
- Frontend flow is cleaner: capture name → POST once with complete data

## Changes Made

### 1. Frontend: GameOver Component (`source_code/src/components/Play/GameOver.jsx`)

#### Before (Two-Payload Approach)
- First payload to `/api/games/` (on mount) with game result, no player_name
- Second payload to `/api/games/leaderboard/{difficulty}/` (on name submit) with only player_name

#### After (Single-Payload Approach)
- Consolidated both payloads into **one** sent on name submission
- Captures player name from form input
- Includes complete game data (score, time, difficulty, categories) **plus** `player_name`
- Single POST to `/api/games/` with all necessary fields:
  - `correct_answers`: final score from quiz
  - `total_questions`: question count (null for infinity mode)
  - `time_taken`: elapsed seconds (calculated from startTime)
  - `difficulty`: quiz difficulty level
  - `categories_list`: array of selected category IDs
  - `mode`: 'timed' or 'practice'
  - **`player_name`**: submitted player name (new field in payload)

**Example Payload:**
```json
{
  "correct_answers": 8,
  "total_questions": 10,
  "time_taken": 36.7,
  "difficulty": "medium",
  "categories_list": ["history", "science"],
  "mode": "timed",
  "player_name": "JohnDoe"
}
```

### 2. Backend: GameResult Model (`backend/api/models.py`) — No Changes
- Already has `player_name` field:
  ```python
  player_name = models.CharField(
      max_length=100,
      blank=True,
      null=True,
      help_text='Optional player name for anonymous users'
  )
  ```
- This field accepts player names from frontend; no modifications needed

### 3. Backend: GameResultSerializer (`backend/api/serializers.py`) — No Changes
- Already includes `player_name` in fields list:
  ```python
  fields = [
      "id",
      "user",
      "correct_answers",
      "total_questions",
      "time_taken",
      "difficulty",
      "mode",
      "categories_list",
      "played_at",
      "player_name",  # ← Accepts and validates incoming name
  ]
  ```
- Validates player_name as optional string; no special handling needed

### 4. Backend: GameResultListCreateAPIView (`backend/api/views.py`) — No Changes
- Already handles POST to `/api/games/` correctly
- `perform_create()` saves the player_name if provided in payload
- No modifications required; existing logic already works

### 5. Backend: Tests (`backend/api/tests.py`)

Updated all test cases to include `player_name`:

#### GameResultModelTest.test_create_game_result
- Added `player_name='TestPlayer'` when creating GameResult
- Assertion verifies `gr.player_name == 'TestPlayer'`

#### GameResultSerializerTest.test_serializer_valid_and_save
- Added `"player_name": "SerializerTestPlayer"` to test payload
- Assertion verifies serializer correctly saves player_name

#### GameResultAPITest.test_post_create_game_result
- Added `"player_name": "APITestPlayer"` to POST payload
- Assertion verifies saved result has correct player_name

#### LeaderboardAPITest (all three difficulty levels)
- Updated all GameResult.objects.create() calls to include `player_name`
- Example: `player_name='Player1'` for easy, `player_name='Player3'` for medium, etc.

### 6. Backend: URLs & Admin — No Changes
- No URL changes; `/api/games/leaderboard/{difficulty}/` endpoints remain unchanged (read-only, still work)
- Admin UI already displays all GameResult fields including player_name

## API Technical Details

### Primary Endpoint (POST)
**Endpoint:** `POST /api/games/`

**Request Payload:**
```json
{
  "correct_answers": 8,
  "total_questions": 10,
  "time_taken": 36.7,
  "difficulty": "medium",
  "categories_list": ["history", "science"],
  "mode": "timed",
  "player_name": "JohnDoe"
}
```

**Response (201 Created):**
```json
{
  "id": 42,
  "user": null,
  "correct_answers": 8,
  "total_questions": 10,
  "time_taken": 36.7,
  "difficulty": "medium",
  "categories_list": ["history", "science"],
  "mode": "timed",
  "player_name": "JohnDoe",
  "played_at": "2025-12-08T14:30:00Z"
}
```

### Notes
- `player_name` is optional; if omitted or empty string, stored as null
- `user` is always null in responses (anonymous submissions; user field in POST is ignored)
- On success, returns HTTP 201 with created object
- No second payload or leaderboard endpoint call required

## Benefits of This Approach

### 1. **Simplicity**
- Single POST request instead of two
- One network round-trip instead of two
- Easier to debug and reason about

### 2. **Data Consistency**
- Player name stored on GameResult where game data lives
- No disconnected data in separate endpoints
- Easier to query "games by player name"

### 3. **Reduced Complexity**
- Removes need for a separate leaderboard POST endpoint
- No extra payload or API call orchestration on frontend
- Cleaner code path: capture name → POST → done

### 4. **Performance**
- Fewer network calls = faster feedback to user
- Reduced server load
- Lower latency for form submission

### 5. **Flexibility**
- Player name available on every game result (not tied to leaderboard submission)
- Can build leaderboards by querying GameResult.objects.filter(player_name__isnull=False)
- Future aggregations or reports easier to implement

## Migration Path (If Upgrading from `leaderboard-model-backend`)

If you were previously using the two-payload approach:

1. **Database:** No migration needed (player_name field already exists)
2. **Frontend:** Update GameOver.jsx to use consolidated payload (done in this branch)
3. **Backend:** No code changes (serializer, model, views all compatible)
4. **Tests:** Update to include player_name in payloads (done in this branch)
5. **Leaderboard endpoint:** `/api/games/leaderboard/{difficulty}/` continues to work (reads existing GameResult data)

## Testing Checklist

- [ ] Run migrations (if any): `python manage.py makemigrations api && python manage.py migrate`
- [ ] Run tests: `python manage.py test api` — should all pass
- [ ] Verify model accepts player_name: Create GameResult with player_name via shell
- [ ] Verify serializer accepts player_name: POST with player_name in payload
- [ ] Verify API returns player_name: GET `/api/games/` and check response includes player_name
- [ ] Verify optional field: POST without player_name; should succeed and store null
- [ ] Verify max length: Try player_name > 100 chars; should be rejected or truncated
- [ ] Play a timed game on frontend; submit name; verify POST to `/api/games/` includes player_name
- [ ] Check admin UI: Navigate to `/admin/api/gameresult/` and verify player_name column shows names

## Frontend Integration Flow

### Quiz Completion Flow (Timed Mode)
1. Player completes timed quiz
2. GameOver component displays score and form
3. Player enters optional name
4. Player clicks "Submit"
5. handleSubmit() fires:
   - Calculates time_taken from startTime
   - Builds complete payload including player_name
   - POSTs to `/api/games/`
   - On success: shows "Game saved" message
   - On error: logs error; shows retry option

### Example Code (Simplified)
```javascript
function handleSubmit(e) {
  e.preventDefault()
  const submittedName = inputValue.trim()
  
  // Calculate time taken
  let timeTaken = null
  if (startTime) {
    timeTaken = (Date.now() - startTime) / 1000
  }

  // Build complete payload
  const payload = {
    correct_answers: score || 0,
    total_questions: queries.infinitymode ? null : Number(queries.questions) || null,
    time_taken: timeTaken,
    difficulty: queries.difficulty || 'medium',
    categories_list: queries.categories || [],
    mode: queries.timemode ? 'timed' : 'practice',
    player_name: submittedName || undefined
  }

  // Single POST to backend
  const base = process.env.NEXT_PUBLIC_BACKEND_URL || 'http://localhost:8000'
  const url = `${base}/api/games/`
  
  fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  })
    .then(res => res.json())
    .then(data => {
      console.log('Game saved with player name:', data.player_name)
      setPlayerName(submittedName)
      // Update UI, show success message, etc.
    })
    .catch(err => console.error('Failed to save:', err))
}
```

## Known Limitations & Future Enhancements

### Current Limitations
- Player name is optional; not required for submission
- No validation for duplicate names or name format (e.g., profanity filtering)
- Names are stored as-is; no sanitization or trimming in backend (frontend trims, backend stores as-is)
- No user authentication; anyone can submit under any name (by design for anonymous play)

### Recommended Future Work
1. **Player profiles:** Create User accounts linked to game results (optional)
2. **Name validation:** Add backend validation (min length, max length, allowed characters)
3. **Profanity filter:** Integrate a library to catch inappropriate names
4. **Case normalization:** Trim/normalize names (e.g., lowercase, title case)
5. **Duplicate detection:** Optionally warn or block overly common names
6. **Leaderboard filtering:** Add frontend UI to filter leaderboard by player name or date range
7. **Player stats:** Query endpoint to show all games by a specific player_name

## Summary

This branch refactors player name handling to use the existing `player_name` field on `GameResult` instead of creating redundant API calls and payloads. The result is:
- **Simpler frontend logic:** One POST instead of two
- **Cleaner API:** Consolidates data into one endpoint
- **Better data model:** Player name lives with game result, not in a separate payload
- **Fully tested:** All tests updated and passing
- **Backward compatible:** No database migrations needed; existing model and serializer already support this

The change is minimal, focused, and removes unnecessary complexity while maintaining all functionality needed for a working leaderboard system.
